<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Äì {{ file.file.name }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .editor-container {
            display: flex;
            gap: 20px;
            min-height: 70vh;
        }
        .image-preview, .video-preview-container {
            flex: 2;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            position: relative;
        }
        .controls {
            flex: 1;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            overflow-y: auto;
            max-height: 80vh;
        }
        .slider-container {
            margin-bottom: 25px;
        }
        .slider {
            width: 100%;
            margin: 10px 0;
        }
        #image-preview, #video-preview {
            max-width: 100%;
            max-height: 70vh;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .btn-save-group {
            display: flex;
            gap: 10px;
            margin-top: 30px;
        }
        .preset-filters {
            margin-bottom: 25px;
        }
        .filter-btn {
            margin-bottom: 8px;
            width: 100%;
            text-align: left;
            position: relative;
            padding-left: 45px;
        }
        .filter-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2rem;
        }
        .filter-badge {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
        }
        .section-title {
            font-weight: 600;
            margin-bottom: 15px;
            color: #495057;
            display: flex;
            align-items: center;
        }
        .section-title i {
            margin-right: 8px;
        }
        #loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            color: white;
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            border-radius: 10px;
        }
        .video-preview {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .processing-status {
            margin-top: 10px;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container py-4">
        <a href="{% url 'view_file' file.id %}" class="btn btn-outline-secondary mb-3">
            <i class="bi bi-arrow-left"></i> –ù–∞–∑–∞–¥
        </a>

        <h2 class="mb-4"><i class="bi bi-sliders"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ {% if is_video %}–≤–∏–¥–µ–æ{% else %}–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è{% endif %}</h2>

        <div class="editor-container">
            <!-- –ü—Ä–µ–≤—å—é -->
            <div class="{% if is_video %}video-preview-container{% else %}image-preview{% endif %}">
                {% if is_video %}
                    <div class="video-preview">
                        <video controls width="100%" id="video-preview" crossorigin="anonymous">
                            <source src="{{ file.file.url }}" type="video/mp4">
                            –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ —Ç–µ–≥.
                        </video>
                        <div class="processing-status mt-2 text-center">
                            {% if file.processing_status == 'processing' %}
                                <div class="spinner-border text-primary"></div>
                                <span class="text-muted">–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–∏–¥–µ–æ...</span>
                            {% endif %}
                        </div>
                    </div>
                {% else %}
                    <img id="image-preview" src="{{ file.file.url }}" alt="–ü—Ä–µ–≤—å—é" class="img-fluid" crossorigin="anonymous">
                {% endif %}
                <div id="loading-overlay">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>

            <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
            <div class="controls">
                <form method="post" id="edit-form" action="{% url 'edit_file' file.id %}">
                    {% csrf_token %}
                    <input type="hidden" name="action" id="form-action" value="save">
                    <input type="hidden" name="preset_filter" id="preset-filter">

                    <!-- –°–µ–∫—Ü–∏—è –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤ -->
                    <div class="preset-filters">
                        <div class="section-title">
                            <i class="bi bi-magic"></i> –§–∏–ª—å—Ç—Ä—ã
                        </div>
                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-outline-primary filter-btn" onclick="applyPreset('bw')">
                                <span class="filter-icon">üéûÔ∏è</span>
                                –ß—ë—Ä–Ω–æ-–±–µ–ª—ã–π
                                <span class="filter-badge badge bg-primary">B&W</span>
                            </button>
                            <button type="button" class="btn btn-outline-primary filter-btn" onclick="applyPreset('noisy')">
                                <span class="filter-icon">üì∞</span>
                                –ü–ª—ë–Ω–æ—á–Ω–æ–µ –∑–µ—Ä–Ω–æ
                                <span class="filter-badge badge bg-primary">Grain</span>
                            </button>
                            <button type="button" class="btn btn-outline-primary filter-btn" onclick="applyPreset('vintage')">
                                <span class="filter-icon">üï∞Ô∏è</span>
                                –í–∏–Ω—Ç–∞–∂
                                <span class="filter-badge badge bg-primary">Vintage</span>
                            </button>
                            <button type="button" class="btn btn-outline-primary filter-btn" onclick="applyPreset('cold')">
                                <span class="filter-icon">‚ùÑÔ∏è</span>
                                –•–æ–ª–æ–¥–Ω—ã–µ —Ç–æ–Ω–∞
                                <span class="filter-badge badge bg-primary">Cold</span>
                            </button>
                            <button type="button" class="btn btn-outline-primary filter-btn" onclick="applyPreset('warm')">
                                <span class="filter-icon">‚òÄÔ∏è</span>
                                –¢—ë–ø–ª—ã–µ —Ç–æ–Ω–∞
                                <span class="filter-badge badge bg-primary">Warm</span>
                            </button>
                            <button type="button" class="btn btn-outline-primary filter-btn" onclick="applyPreset('dramatic')">
                                <span class="filter-icon">üé≠</span>
                                –î—Ä–∞–º–∞—Ç–∏—á–Ω—ã–π
                                <span class="filter-badge badge bg-primary">Drama</span>
                            </button>
                            <button type="button" class="btn btn-outline-primary filter-btn" onclick="applyPreset('pastel')">
                                <span class="filter-icon">üå∏</span>
                                –ü–∞—Å—Ç–µ–ª—å–Ω—ã–π
                                <span class="filter-badge badge bg-primary">Pastel</span>
                            </button>
                            <button type="button" class="btn btn-outline-primary filter-btn" onclick="applyPreset('neon')">
                                <span class="filter-icon">üí°</span>
                                –ù–µ–æ–Ω–æ–≤—ã–π
                                <span class="filter-badge badge bg-primary">Neon</span>
                            </button>
                        </div>
                    </div>

                    <!-- –°–µ–∫—Ü–∏—è —Ä—É—á–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ -->
                    <div class="manual-adjustments">
                        <div class="section-title">
                            <i class="bi bi-tools"></i> –†—É—á–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞
                        </div>
                        <div class="slider-container">
                            <label for="brightness" class="form-label">–Ø—Ä–∫–æ—Å—Ç—å: <span id="brightness-value">0</span></label>
                            <input type="range" class="slider" id="brightness" name="brightness"
                                   min="-100" max="100" value="0" oninput="updatePreview()">
                        </div>

                        <div class="slider-container">
                            <label for="contrast" class="form-label">–ö–æ–Ω—Ç—Ä–∞—Å—Ç: <span id="contrast-value">1.0</span></label>
                            <input type="range" class="slider" id="contrast" name="contrast"
                                   min="0" max="3" step="0.1" value="1.0" oninput="updatePreview()">
                        </div>

                        <div class="slider-container">
                            <label for="saturation" class="form-label">–ù–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç—å: <span id="saturation-value">1.0</span></label>
                            <input type="range" class="slider" id="saturation" name="saturation"
                                   min="0" max="3" step="0.1" value="1.0" oninput="updatePreview()">
                        </div>

                        <div class="slider-container">
                            <label for="blur" class="form-label">–†–∞–∑–º—ã—Ç–∏–µ: <span id="blur-value">0</span></label>
                            <input type="range" class="slider" id="blur" name="blur"
                                   min="0" max="10" value="0" oninput="updatePreview()">
                        </div>
                    </div>

                    <!-- –ö–Ω–æ–ø–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è -->
                    <div class="btn-save-group">
                        <button type="button" class="btn btn-secondary" onclick="resetSliders()">
                            <i class="bi bi-arrow-counterclockwise"></i> –°–±—Ä–æ—Å–∏—Ç—å
                        </button>
                        <button type="button" class="btn btn-success" onclick="saveAsCopy()">
                            <i class="bi bi-files"></i> –ö–æ–ø–∏—è
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        {% if not is_video %}
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Canvas (—Ç–æ–ª—å–∫–æ –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π)
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const previewImg = document.getElementById('image-preview');
        let currentParams = {
            brightness: 0,
            contrast: 1.0,
            saturation: 1.0,
            blur: 0,
            preset: null
        };

        // –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        const originalImage = new Image();
        originalImage.crossOrigin = "Anonymous";
        originalImage.src = previewImg.src + "?t=" + new Date().getTime();

        originalImage.onload = function() {
            canvas.width = this.naturalWidth;
            canvas.height = this.naturalHeight;
            drawPreview();
        };

        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–µ–≤—å—é
        function drawPreview() {
            if (!canvas || !ctx || !originalImage.complete) return;

            // –û—á–∏—â–∞–µ–º canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
            ctx.filter = `
                brightness(${100 + currentParams.brightness}%)
                contrast(${currentParams.contrast * 100}%)
                saturate(${currentParams.saturation * 100}%)
                blur(${currentParams.blur}px)
            `;

            // –†–∏—Å—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å —ç—Ñ—Ñ–µ–∫—Ç–∞–º–∏
            ctx.drawImage(originalImage, 0, 0, canvas.width, canvas.height);

            // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–≤—å—é
            previewImg.src = canvas.toDataURL();
        }
        {% else %}
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–∏–¥–µ–æ –ø–ª–µ–µ—Ä–∞
        document.addEventListener('DOMContentLoaded', function() {
            const video = document.getElementById('video-preview');
            if (video) {
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                video.load();

                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
                video.addEventListener('error', function() {
                    console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ:", video.error);
                });
            }
        });

        // –î–ª—è –≤–∏–¥–µ–æ –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è, –Ω–æ –Ω–µ –ø—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
        function drawPreview() {
            // –î–ª—è –≤–∏–¥–µ–æ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –ø—Ä–µ–≤—å—é —Ñ–∏–ª—å—Ç—Ä–æ–≤
            return;
        }
        {% endif %}

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π –ø–æ–ª–∑—É–Ω–∫–æ–≤
        function updatePreview() {
            currentParams = {
                brightness: parseInt(document.getElementById('brightness').value),
                contrast: parseFloat(document.getElementById('contrast').value),
                saturation: parseFloat(document.getElementById('saturation').value),
                blur: parseInt(document.getElementById('blur').value),
                preset: document.getElementById('preset-filter').value
            };

            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
            document.getElementById('brightness-value').textContent = currentParams.brightness;
            document.getElementById('contrast-value').textContent = currentParams.contrast.toFixed(1);
            document.getElementById('saturation-value').textContent = currentParams.saturation.toFixed(1);
            document.getElementById('blur-value').textContent = currentParams.blur;

            drawPreview();
        }

        // –°–±—Ä–æ—Å –ø–æ–ª–∑—É–Ω–∫–æ–≤
        function resetSliders() {
            document.getElementById('brightness').value = 0;
            document.getElementById('contrast').value = 1.0;
            document.getElementById('saturation').value = 1.0;
            document.getElementById('blur').value = 0;
            document.getElementById('preset-filter').value = '';
            updatePreview();
        }

        // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–≥–æ —Ñ–∏–ª—å—Ç—Ä–∞
        function applyPreset(filterName) {
            const presets = {
                'bw': {brightness: 0, contrast: 1.1, saturation: 0, blur: 0},
                'noisy': {brightness: 10, contrast: 1.2, saturation: 1.1, blur: 0},
                'vintage': {brightness: -15, contrast: 0.9, saturation: 0.7, blur: 1},
                'cold': {brightness: 5, contrast: 1.0, saturation: 1.3, blur: 0},
                'warm': {brightness: 10, contrast: 1.1, saturation: 1.4, blur: 0},
                'dramatic': {brightness: -20, contrast: 1.5, saturation: 1.2, blur: 0},
                'pastel': {brightness: 20, contrast: 0.9, saturation: 0.8, blur: 2},
                'neon': {brightness: 5, contrast: 1.3, saturation: 2.0, blur: 0}
            };

            if (presets[filterName]) {
                document.getElementById('brightness').value = presets[filterName].brightness;
                document.getElementById('contrast').value = presets[filterName].contrast;
                document.getElementById('saturation').value = presets[filterName].saturation;
                document.getElementById('blur').value = presets[filterName].blur;
                document.getElementById('preset-filter').value = filterName;
                updatePreview();
            }
        }

        // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ –∫–æ–ø–∏—é
        function saveAsCopy() {
            showLoading();
            document.getElementById('form-action').value = "save_copy";
            document.getElementById('edit-form').submit();
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        function showLoading() {
            document.getElementById('loading-overlay').style.display = 'flex';
        }

        // –°–∫—Ä—ã—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ (–µ—Å–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è)
        window.addEventListener('load', function() {
            document.getElementById('loading-overlay').style.display = 'none';
        });
    </script>
</body>
</html>